<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KURA STUDIO | Ëîµ„Çπ„Çø„Ç∏„Ç™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&family=Space+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'cyber': ['"Saira Stencil One"', 'sans-serif'],
                        'mono': ['"Space Mono"', 'monospace'],
                        'jp': ['"Noto Sans JP"', 'sans-serif'],
                    },
                    colors: {
                        'neon-red': '#FF003C', /* Color principal de acento */
                        'void': '#000000', /* Negro absoluto */
                        'panel': '#111111',
                        'data-gray': '#AAAAAA',
                    },
                    animation: {
                        'flicker-slow': 'flicker 1.5s infinite alternate',
                        'flicker-fast': 'flicker 0.1s infinite alternate',
                        'glitch': 'glitch 0.8s steps(2, end) infinite alternate',
                    },
                    keyframes: {
                        'flicker': {
                            '0%': { opacity: 0.95 },
                            '100%': { opacity: 0.8 },
                        },
                        'glitch': {
                            '0%': { transform: 'translate(1px, 1px)', textShadow: '2px 2px #FF003C, -2px -2px #00FFFF' },
                            '50%': { transform: 'translate(-1px, -1px)', textShadow: '-2px -2px #FF003C, 2px 2px #00FFFF' },
                            '100%': { transform: 'translate(0, 0)', textShadow: 'none' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos Base - Alto Contraste y Monoespacio */
        body { background-color: #000000; color: #E0E0E0; font-family: 'Space Mono', monospace; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        
        /* Secci√≥n Hero - El Terminal */
        .hero-terminal {
            background-color: #050505;
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%231a1a1a' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M.905.589L0 1.5V0h1.5l-.595.589zM1.085 0H2.5v1.41L1.085 0zM3.5 0h1.415L3.5 1.41V0zM6 1.5V0h-1.5l.595.589zM.589 6L1.5 6V4.5L0 4.5V6l.589 0zM0 3.5h1.41L0 2.085V3.5zM6 3.5V2.085L4.59 3.5H6zM6 4.5L4.5 4.5V6l1.411 0z'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* T√≠tulo Glitch en Hero */
        #hero-title {
            animation: glitch 0.8s steps(2, end) infinite alternate;
            text-shadow: 2px 2px #FF003C, -2px -2px #00FFFF;
        }

        /* Estilos de Tarjeta (Panel de Datos) */
        .product-card {
            background: #0D0D0D;
            border: 3px solid #333; /* Borde grueso y visible */
            transition: all 0.2s ease;
            box-shadow: 6px 6px 0px #1a1a1a;
        }
        .product-card:hover { 
            border-color: #FF003C; 
            transform: translate(0, -5px); 
            box-shadow: 8px 8px 0px #FF003C; /* Sombra Neon-Red */
        }
        
        /* Bot√≥n Agresivo (Bot√≥n de Comando) */
        .aggressive-btn {
            background: #FF003C; 
            color: white; 
            font-weight: 700; 
            text-transform: uppercase;
            border: 3px solid #FF003C;
            box-shadow: 4px 4px 0px black;
            transition: all 0.2s; 
            font-family: 'Space Mono', monospace;
        }
        .aggressive-btn:hover { 
            background: #FF5A7D; 
            box-shadow: 6px 6px 0px black; 
            transform: translate(-1px, -1px);
        }

        /* Talla activa */
        .size-btn {
            transition: all 0.1s;
        }
        .size-btn.active {
            background-color: #FF003C !important;
            color: white !important;
            border-color: #FF003C !important;
            box-shadow: 0 0 8px #FF003C; /* Brillo */
        }
        .size-btn:hover {
            border-color: #FF003C;
        }

        /* Toastify Custom */
        .toastify { 
            background: #111 !important; 
            border: 2px solid #FF003C; 
            box-shadow: 0 0 10px rgba(255, 0, 60, 0.5);
            font-family: 'Space Mono', monospace; 
            font-weight: bold; 
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    
    <!-- Navbar HUD (Heads-Up Display) -->
    <nav class="fixed top-0 w-full z-40 bg-void/90 backdrop-blur-sm border-b-2 border-neon-red/50">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <a href="#home" onclick="router.navigate('home')" class="flex flex-col leading-none group">
                <span class="text-2xl font-cyber text-white tracking-widest group-hover:text-neon-red transition">KURA</span>
                <span class="text-[8px] font-jp text-data-gray tracking-[0.3em] group-hover:text-white">Ëîµ„Çπ„Çø„Ç∏„Ç™</span>
            </a>
            <div class="flex items-center gap-4">
                <!-- Estado del Usuario -->
                <div id="user-display" class="text-xs text-data-gray font-mono">
                    <!-- Cargado por JS -->
                </div>
                <button onclick="cartManager.toggle()" class="relative p-2 group">
                    <div class="absolute -top-1 -right-1 bg-neon-red text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border border-void" id="cart-counter">0</div>
                    <i class="fas fa-shopping-cart text-xl text-data-gray group-hover:text-neon-red transition"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- MODAL DE ACCESO (Login / Registro) -->
    <div id="login-modal" class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/95 backdrop-blur-md transition-opacity duration-300">
        <div class="bg-panel p-8 w-full max-w-sm border-4 border-neon-red shadow-[0_0_15px_rgba(255,0,60,0.5)] relative">
            <h2 class="text-4xl font-cyber mb-6 text-center text-neon-red">PROTOCOLO_DE_ACCESO</h2>
            <input id="l-email" type="email" placeholder="CORREO" class="w-full bg-void border-2 border-gray-700 p-3 mb-3 text-sm focus:border-neon-red outline-none text-white font-mono placeholder-gray-700" value="test@user.com">
            <input id="l-pass" type="password" placeholder="CONTRASE√ëA" class="w-full bg-void border-2 border-gray-700 p-3 mb-6 text-sm focus:border-neon-red outline-none text-white font-mono placeholder-gray-700" value="password">
            
            <button onclick="authLogic.login()" class="w-full aggressive-btn py-3 mb-3">ACCEDER // EJECUTAR</button>
            <button onclick="authLogic.register()" class="w-full bg-data-gray text-void font-bold py-3 text-xs hover:bg-white transition border-2 border-data-gray">CREAR CUENTA</button>
            
            <button onclick="router.closeModal('login-modal')" class="absolute top-2 right-2 text-gray-500 hover:text-neon-red transition"><i class="fas fa-times"></i></button>
        </div>
    </div>
    
    <!-- MODAL DE CONFIRMACI√ìN DE ORDEN -->
    <div id="order-confirm-modal" class="fixed inset-0 z-[85] hidden items-center justify-center bg-black/90 backdrop-blur-md transition-opacity duration-300">
        <div class="bg-[#080808] p-6 w-full max-w-lg border-4 border-neon-red shadow-[0_0_20px_rgba(255,0,60,0.7)] relative max-h-[90vh] overflow-y-auto">
            <h2 class="text-3xl font-cyber mb-4 text-neon-red tracking-widest">CONFIRMAR // DETALLES_ORDEN</h2>
            <p class="text-xs text-data-gray font-mono mb-6 border-b border-gray-800 pb-2">REVISA TU INFORMACI√ìN ANTES DE INICIAR TRANSMISI√ìN POR WHATSAPP.</p>
            
            <!-- Resumen de Cliente -->
            <div class="mb-6">
                <h3 class="text-xl font-cyber text-white mb-2 border-l-4 border-data-gray pl-2">DATOS_PILOTO</h3>
                <div class="space-y-1 text-sm font-mono ml-4">
                    <p>Nombre: <span id="confirm-name" class="text-white font-bold"></span></p>
                    <p>Tel√©fono: <span id="confirm-phone" class="text-white font-bold"></span></p>
                    <p>Entrega: <span id="confirm-delivery" class="text-neon-red font-bold uppercase"></span></p>
                    <p id="confirm-address-display" class="hidden">Direcci√≥n: <span id="confirm-address" class="text-white font-bold"></span></p>
                </div>
            </div>

            <!-- Resumen de Productos -->
            <div class="mb-6">
                <h3 class="text-xl font-cyber text-white mb-2 border-l-4 border-data-gray pl-2">LISTA_EQUIPO</h3>
                <ul id="confirm-items-list" class="space-y-2 text-sm font-mono ml-4 max-h-40 overflow-y-auto pr-2">
                    <!-- Items inyectados por JS -->
                </ul>
            </div>

            <!-- Total Final -->
            <div class="text-right pt-4 border-t-2 border-data-gray mt-4">
                <span class="text-data-gray text-sm font-mono block">COSTO_FINAL</span>
                <span id="confirm-total" class="text-5xl font-cyber text-neon-red">C$ 0</span>
            </div>

            <div class="mt-8 space-y-3">
                <button onclick="logic.sendOrderToWhatsapp()" class="w-full aggressive-btn py-4 text-sm tracking-[0.2em] flex items-center justify-center gap-3">
                    <i class="fab fa-whatsapp text-lg"></i> CONFIRMAR Y ORDENAR // EJECUTAR
                </button>
                <button onclick="router.closeModal('order-confirm-modal')" class="w-full bg-[#333] text-data-gray py-3 text-sm font-mono hover:bg-[#555] transition">
                    CANCELAR // ABORTAR
                </button>
            </div>
            
        </div>
    </div>


    <!-- Contenedor de la App (para enrutamiento) -->
    <main id="app-container" class="flex-grow pt-16 pb-10 min-h-screen container mx-auto px-4"></main>

    <!-- Barra Lateral del Carrito (Flujo de Datos) -->
    <div id="cart-sidebar" class="fixed inset-y-0 right-0 w-full md:w-[400px] bg-[#080808] border-l-4 border-neon-red z-[60] transform translate-x-full transition-transform duration-300 flex flex-col shadow-2xl">
        <!-- Encabezado del Carrito -->
        <div class="p-4 border-b-2 border-neon-red/50 flex justify-between items-center bg-black/50">
            <div>
                <h2 class="text-2xl font-cyber text-neon-red tracking-widest">CARRITO // <span class="text-white">FLUJO</span></h2>
                <p class="text-[10px] text-data-gray font-mono">ID_PILOTO: <span id="pilot-id">...</span></p>
            </div>
            <button onclick="cartManager.toggle()" class="text-data-gray hover:text-white transition"><i class="fas fa-times text-2xl"></i></button>
        </div>

        <!-- Lista de Items -->
        <div id="cart-items-container" class="flex-1 overflow-y-auto p-4 space-y-3"></div>

        <!-- Secci√≥n de Pago -->
        <div id="checkout-section" class="p-4 bg-void border-t-4 border-neon-red relative shadow-[0_0_20px_rgba(255,0,60,0.5)]">
            <div class="flex justify-between items-end mb-4 font-mono border-b border-gray-800 pb-2">
                <span class="text-data-gray text-sm">COSTO_TOTAL</span>
                <span class="text-4xl font-bold text-neon-red" id="cart-total">C$ 0</span>
            </div>

            <!-- Formulario -->
            <div class="space-y-3 mb-4">
                <input type="text" id="cust-name" placeholder="NOMBRE COMPLETO" class="w-full bg-void border-2 border-gray-700 p-3 text-sm text-white focus:border-neon-red outline-none transition placeholder-gray-700 font-mono">
                <input type="tel" id="cust-phone" placeholder="WHATSAPP / CELULAR" class="w-full bg-void border-2 border-gray-700 p-3 text-sm text-white focus:border-neon-red outline-none transition placeholder-gray-700 font-mono">
                
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <button onclick="logic.setDelivery('pickup')" id="btn-pickup" class="py-3 text-xs font-bold border-2 border-gray-700 text-data-gray hover:text-white hover:border-neon-red transition flex flex-col items-center gap-1 font-mono">
                        <i class="fas fa-store"></i> RECOGER
                    </button>
                    <button onclick="logic.setDelivery('delivery')" id="btn-delivery" class="py-3 text-xs font-bold border-2 border-gray-700 text-data-gray hover:text-white hover:border-neon-red transition flex flex-col items-center gap-1 font-mono">
                        <i class="fas fa-motorcycle"></i> ENTREGA
                    </button>
                </div>

                <textarea id="cust-address" placeholder="DIRECCI√ìN EXACTA DE ENTREGA..." class="hidden w-full bg-void border-2 border-gray-700 p-3 text-sm text-white focus:border-neon-red outline-none h-16 resize-none placeholder-gray-700 mt-2 font-mono"></textarea>
            </div>

            <button onclick="logic.openConfirmModal()" class="w-full aggressive-btn py-4 text-sm tracking-[0.2em] flex items-center justify-center gap-3">
                <i class="fab fa-whatsapp text-lg"></i> REVISAR Y ORDENAR // PREPARAR
            </button>
        </div>
    </div>
    <div id="cart-overlay" onclick="cartManager.toggle()" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[55] hidden transition-opacity opacity-0"></div>

    <!-- Redes Sociales (Nueva Secci√≥n) -->
    <div class="w-full py-8 border-t-4 border-data-gray/30 mt-auto">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm font-cyber text-neon-red mb-4 tracking-widest">REDES // CONEXI√ìN</p>
            <div class="flex justify-center space-x-6">
                <!-- WhatsApp -->
                <a href="https://wa.me/50584016969" target="_blank" class="text-data-gray hover:text-green-500 transition-colors">
                    <i class="fab fa-whatsapp text-4xl"></i>
                </a>
                <!-- Instagram -->
                <a href="https://instagram.com/kura.studio" target="_blank" class="text-data-gray hover:text-pink-500 transition-colors">
                    <i class="fab fa-instagram text-4xl"></i>
                </a>
            </div>
            <p class="text-[10px] font-mono text-data-gray mt-6">&copy; KURA STUDIO - TODOS LOS DERECHOS RESERVADOS</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, child, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Configuraci√≥n de Firebase Realtime DB (Reemplazar con tus claves)
        // NOTA: Estas claves son de ejemplo y DEBEN ser reemplazadas por tus propias claves de Firebase.
        const firebaseConfig = {
            apiKey: "AIzaSyDhIbUHfD8FARW9kz8ekqp5O0jqZQU7etc",
            authDomain: "kura-studio.firebaseapp.com",
            databaseURL: "https://kura-studio-default-rtdb.firebaseio.com",
            projectId: "kura-studio",
            storageBucket: "kura-studio.firebasestorage.app",
            messagingSenderId: "238358999866",
            appId: "1:238358999866:web:9fc2e446d816dae8981603"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- ESTADO GLOBAL ---
        const state = {
            products: [],
            cart: JSON.parse(localStorage.getItem('cart')) || [],
            user: null, // Objeto de usuario global
            selectedSize: null, // Estado temporal para la talla seleccionada en el detalle del producto
            deliveryType: 'pickup', // O 'delivery'
            orderData: {} // Objeto temporal para guardar datos para el modal de confirmaci√≥n
        };

        // --- UTILIDADES ---
        const formatMoney = (amount) => {
            if (amount === undefined || amount === null || isNaN(amount)) return 'C$ 0';
            // Formateo a c√≥rdobas nicarag√ºenses (C$)
            return `C$ ${Number(amount).toLocaleString('es-NI')}`;
        };

        const showToast = (msg, type = 'success') => {
            Toastify({
                text: msg, duration: 2500, gravity: "bottom", position: "center",
                className: "toastify",
                style: { 
                    background: type === 'error' ? "rgba(255, 0, 60, 0.95)" : "rgba(0, 0, 0, 0.95)", 
                    color: type === 'error' ? "white" : "#FF003C",
                    border: type === 'error' ? "2px solid white" : "2px solid #FF003C",
                    boxShadow: type === 'error' ? "0 0 10px rgba(255, 0, 60, 0.5)" : "0 0 10px rgba(255, 0, 60, 0.5)",
                    fontWeight: "900", 
                    textTransform: "uppercase",
                    fontSize: "12px",
                    letterSpacing: "1px",
                    fontFamily: 'Space Mono, monospace'
                }
            }).showToast();
        };

        // --- L√ìGICA DE AUTENTICACI√ìN ---
        window.authLogic = {
            login: async () => {
                try {
                    const email = document.getElementById('l-email').value;
                    const pass = document.getElementById('l-pass').value;
                    await signInWithEmailAndPassword(auth, email, pass);
                    router.closeModal('login-modal');
                    showToast('ACCESO CONCEDIDO // EN L√çNEA', 'success');
                } catch(e) { 
                    showToast('ERROR DE ACCESO // DENEGADO', 'error');
                }
            },
            register: async () => {
                 try {
                    const email = document.getElementById('l-email').value;
                    const pass = document.getElementById('l-pass').value;
                    await createUserWithEmailAndPassword(auth, email, pass);
                    router.closeModal('login-modal');
                    showToast('CUENTA CREADA // CONECTANDO', 'success');
                } catch(e) { 
                    showToast('ERROR AL CREAR CUENTA', 'error');
                }
            },
            logout: () => {
                signOut(auth);
                showToast('SESI√ìN TERMINADA // DESCONECTADO', 'success');
            }
        };

        onAuthStateChanged(auth, (u) => {
            state.user = u;
            const div = document.getElementById('user-display');
            // Muestra solo los primeros 8 caracteres del UID para la est√©tica Cyber
            document.getElementById('pilot-id').innerText = u ? u.uid.substring(0, 8) : 'INVITADO';
            
            if(u) {
                div.innerHTML = `<span class="text-neon-red">PILOTO</span> / <button onclick="authLogic.logout()" class="underline text-data-gray hover:text-white transition">SALIR</button>`;
            } else {
                div.innerHTML = `<button onclick="router.openModal('login-modal')" class="text-neon-red underline font-bold hover:text-white transition">ACCEDER</button>`;
            }
        });


        // --- L√ìGICA DE ECOMMERCE ---
        window.logic = {
            init: async () => {
                await logic.fetchProducts();
                router.loadRoute();
                window.onhashchange = router.loadRoute;
            },

            fetchProducts: async () => {
                try {
                    // Carga desde Firebase Realtime DB
                    const snapshot = await get(child(ref(db), 'products'));
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        // Almacenar productos con su ID
                        state.products = Object.keys(data).map(key => ({ 
                            id: key, 
                            ...data[key],
                            // Asegurarse de que price es n√∫mero
                            price: parseFloat(data[key].price) || 0,
                        }));
                    } else {
                         // Datos de prueba (Mock data) si no hay nada en la DB
                        state.products = [
                            { id: 'item001', name: 'CYBER SAMURAI TEE', price: 350, category: 'CAMISETA', description: 'El uniforme de combate del futuro. Algod√≥n org√°nico infundido con grafeno.', sizesString: 'S,M,L,XL', imageUrl: 'https://placehold.co/600x800/222222/FF003C?text=CAMISETA' },
                            { id: 'item002', name: 'NEO-SEOUL HOODIE', price: 650, category: 'SUDADERA', description: 'Calor para las noches fr√≠as del distrito 7. Serigraf√≠a de alta densidad y ajuste oversize.', sizesString: 'M,L,XL', imageUrl: 'https://placehold.co/600x800/222222/FF003C?text=SUDADERA' },
                            { id: 'item003', name: 'DATA-STREAM CAP', price: 200, category: 'ACCESORIO', description: 'Visor de datos integrado. Tejido t√©cnico reflectante y ajuste trasero con velcro industrial.', sizesString: 'UNICA', imageUrl: 'https://placehold.co/600x800/222222/FF003C?text=GORRA' },
                            { id: 'item004', name: 'KITSUNE MASK', price: 800, category: 'ACCESORIO', description: 'R√©plica de m√°scara ceremonial Kitsune, dise√±ada para la infiltraci√≥n nocturna.', sizesString: 'UNICA', imageUrl: 'https://placehold.co/600x800/222222/FF003C?text=MASCARA' },
                        ];
                    }
                } catch (e) {
                    console.error("Error al obtener productos, usando datos de prueba:", e);
                    // Asegurarse de que al menos hay mock data si la conexi√≥n falla
                    state.products = [
                        { id: 'item001', name: 'CYBER SAMURAI TEE', price: 350, category: 'CAMISETA', description: 'El uniforme de combate del futuro. Algod√≥n org√°nico infundido con grafeno.', sizesString: 'S,M,L,XL', imageUrl: 'https://placehold.co/600x800/222222/FF003C?text=CAMISETA' },
                        { id: 'item002', name: 'NEO-SEOUL HOODIE', price: 650, category: 'SUDADERA', description: 'Calor para las noches fr√≠as del distrito 7. Serigraf√≠a de alta densidad y ajuste oversize.', sizesString: 'M,L,XL', imageUrl: 'https://placehold.co/600x800/222222/FF003C?text=SUDADERA' },
                        { id: 'item003', name: 'DATA-STREAM CAP', price: 200, category: 'ACCESORIO', description: 'Visor de datos integrado. Tejido t√©cnico reflectante y ajuste trasero con velcro industrial.', sizesString: 'UNICA', imageUrl: 'https://placehold.co/600x800/222222/FF003C?text=GORRA' },
                        { id: 'item004', name: 'KITSUNE MASK', price: 800, category: 'ACCESORIO', description: 'R√©plica de m√°scara ceremonial Kitsune, dise√±ada para la infiltraci√≥n nocturna.', sizesString: 'UNICA', imageUrl: 'https://placehold.co/600x800/222222/FF003C?text=MASCARA' },
                    ];
                }
            },

            renderProductsGrid: () => {
                const grid = document.getElementById('products-grid');
                if(!grid) return;
                
                grid.innerHTML = '';
                
                if (state.products.length === 0) {
                     grid.innerHTML = '<div class="col-span-full text-center py-20 text-data-gray font-mono">Cargando datos...</div>';
                     return;
                }

                state.products.forEach(p => {
                    // Usar 'image' o 'imageUrl' o un placeholder tem√°tico
                    const img = p.image || p.imageUrl || 'https://placehold.co/600x800/000000/FF003C?text=EQUIPO+FALTANTE';
                    
                    grid.innerHTML += `
                        <a href="#product/${p.id}" class="product-card group cursor-pointer overflow-hidden block">
                            <div class="relative w-full pt-[125%] bg-[#1a1a1a] overflow-hidden">
                                <img src="${img}" onerror="this.src='https://placehold.co/600x800/000000/FF003C?text=EQUIPO+FALTANTE'" class="absolute top-0 left-0 w-full h-full object-cover transition duration-500 group-hover:scale-105" loading="lazy">
                                <div class="absolute top-0 left-0 w-full h-full bg-black/30 transition duration-300 group-hover:bg-black/0"></div>
                                <div class="absolute top-3 right-3 bg-neon-red px-2 py-1 border-2 border-void">
                                    <span class="text-[10px] font-bold text-white tracking-widest uppercase font-mono">${p.category || 'ITEM'}</span>
                                </div>
                            </div>
                            <div class="p-4 bg-[#0d0d0d]">
                                <h3 class="text-white font-bold text-lg leading-tight mb-2 uppercase truncate group-hover:text-neon-red transition font-cyber">${p.name}</h3>
                                <div class="flex justify-between items-center border-t border-gray-800 pt-3">
                                    <p class="text-neon-red font-mono font-extrabold text-xl">${formatMoney(p.price)}</p>
                                    <i class="fas fa-external-link-alt text-data-gray group-hover:text-neon-red transition"></i>
                                </div>
                            </div>
                        </a>
                    `;
                });
            },

            renderProductDetail: (productId) => {
                const p = state.products.find(x => x.id === productId);
                const container = document.getElementById('app-container');

                if (!p) {
                    container.innerHTML = `<div class="text-center py-20 text-data-gray font-mono">ERROR 404: PRODUCTO NO ENCONTRADO. <a href="#home" class="text-neon-red">VOLVER</a></div>`;
                    return;
                }
                
                // Reiniciar la selecci√≥n de talla para la nueva vista
                state.selectedSize = null;

                const img = p.image || p.imageUrl || 'https://placehold.co/800x1000/000000/FF003C?text=EQUIPO+FALTANTE';
                
                container.innerHTML = `
                    <div class="pt-8 pb-16">
                        <a href="#home" class="text-data-gray hover:text-white transition text-sm mb-8 block font-mono"><i class="fas fa-arrow-left mr-2"></i> VOLVER AL INVENTARIO</a>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 bg-panel p-6 md:p-10 border-4 border-gray-800 shadow-xl">
                            <!-- Columna Imagen -->
                            <div class="relative w-full pt-[125%] bg-[#000] border-2 border-data-gray">
                                <img id="detail-img" src="${img}" onerror="this.src='https://placehold.co/800x1000/000000/FF003C?text=EQUIPO+FALTANTE'" class="absolute top-0 left-0 w-full h-full object-cover">
                                <div class="absolute bottom-4 left-4 bg-black/80 border-2 border-neon-red px-2 py-1 text-[10px] text-white font-mono tracking-widest">ID_UNIDAD: ${p.id.substring(0, 8)}</div>
                            </div>

                            <!-- Columna Info -->
                            <div class="flex flex-col">
                                <span class="text-xs font-mono text-data-gray uppercase tracking-widest">${p.category || 'EQUIPO'}</span>
                                <h2 id="detail-title" class="text-5xl md:text-7xl font-cyber text-white leading-none uppercase mt-1 mb-4">${p.name}</h2>
                                
                                <p id="detail-price" class="text-3xl text-neon-red font-bold font-mono border-b-2 border-neon-red pb-4">${formatMoney(p.price)}</p>
                                
                                <div class="flex-1 mt-6">
                                    <p id="detail-desc" class="text-data-gray text-sm leading-relaxed mb-8 font-mono border-l-4 border-data-gray pl-4">${p.desc || p.description || 'Sin informaci√≥n adicional. Prepare su equipo para el combate.'}</p>
                                    
                                    <!-- Selector de Tallas -->
                                    <div class="mb-8">
                                        <label class="text-sm font-bold text-gray-300 mb-3 block uppercase tracking-widest font-mono">SELECCIONAR TALLA <span class="text-neon-red">*</span></label>
                                        <div id="detail-sizes" class="flex flex-wrap gap-3">
                                            <!-- JS Inyecta botones aqu√≠ -->
                                        </div>
                                    </div>
                                </div>

                                <button id="detail-btn-add" class="w-full aggressive-btn py-4 tracking-[0.2em] text-sm font-cyber">
                                    AGREGAR AL SISTEMA // +1
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                logic.renderSizes(p);
                document.getElementById('detail-btn-add').onclick = () => {
                    if (!state.selectedSize) {
                        document.getElementById('detail-sizes').classList.add('animate-flicker-fast');
                        setTimeout(() => document.getElementById('detail-sizes').classList.remove('animate-flicker-fast'), 500);
                        return showToast('‚ö†Ô∏è SELECCIONA UNA TALLA', 'error');
                    }
                    cartManager.add(p, state.selectedSize);
                };
            },

            renderSizes: (p) => {
                const sizesContainer = document.getElementById('detail-sizes');
                sizesContainer.innerHTML = '';
                
                let sizes = Array.isArray(p.sizes) ? p.sizes : (typeof p.sizesString === 'string' ? p.sizesString.split(',') : ['UNICA']);
                sizes = sizes.map(s => s.trim()).filter(s => s); // Limpieza de tallas

                sizes.forEach(s => {
                    const btn = document.createElement('button');
                    btn.className = 'size-btn border-2 border-gray-700 text-data-gray w-12 h-12 flex items-center justify-center font-bold font-mono text-sm hover:border-white transition bg-[#0A0A0A]';
                    btn.innerText = s;
                    
                    btn.onclick = () => {
                        // 1. Quitar clase 'active' de todos
                        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                        // 2. Activar este
                        btn.classList.add('active');
                        // 3. Guardar valor global
                        state.selectedSize = s;
                    };
                    sizesContainer.appendChild(btn);
                });
            },

            // --- L√ìGICA DE PAGO ---
            setDelivery: (type) => {
                state.deliveryType = type;
                const addr = document.getElementById('cust-address');
                const btnP = document.getElementById('btn-pickup');
                const btnD = document.getElementById('btn-delivery');

                // Resetear estilos
                [btnP, btnD].forEach(b => b.classList.remove('border-neon-red', 'text-neon-red', 'bg-gray-900', 'shadow-[0_0_10px_rgba(255,0,60,0.5)]'));
                [btnP, btnD].forEach(b => b.classList.add('border-gray-700', 'text-data-gray'));

                if (type === 'delivery') {
                    addr.classList.remove('hidden');
                    btnD.classList.add('border-neon-red', 'text-neon-red', 'bg-[#110005]', 'shadow-[0_0_10px_rgba(255,0,60,0.5)]');
                    btnD.classList.remove('border-gray-700', 'text-data-gray');
                    addr.focus();
                } else {
                    addr.classList.add('hidden');
                    btnP.classList.add('border-neon-red', 'text-neon-red', 'bg-[#110005]', 'shadow-[0_0_10px_rgba(255,0,60,0.5)]');
                    btnP.classList.remove('border-gray-700', 'text-data-gray');
                }
            },
            
            // Paso 1: Validar y abrir modal de confirmaci√≥n
            openConfirmModal: () => {
                if (state.cart.length === 0) {
                    showToast('CARRITO VAC√çO. AGREGA ITEMS', 'error');
                    return;
                }
                
                // CR√çTICO: Verificar estado de Autenticaci√≥n
                if (!state.user) {
                    cartManager.toggle(); // Cerrar carrito
                    router.openModal('login-modal'); // Abrir modal de acceso
                    return showToast('üö´ DEBES INICIAR SESI√ìN PARA ORDENAR', 'error');
                }

                const name = document.getElementById('cust-name').value.trim();
                const phone = document.getElementById('cust-phone').value.trim();
                const address = document.getElementById('cust-address').value.trim();
                const total = state.cart.reduce((sum, item) => sum + (item.price || 0), 0);

                if (!name || !phone) return showToast('COMPLETA TUS DATOS', 'error');
                if (state.deliveryType === 'delivery' && !address) return showToast('INGRESA DIRECCI√ìN', 'error');

                // Preparar Datos para el modal
                state.orderData = {
                    name,
                    phone,
                    address: state.deliveryType === 'delivery' ? address : 'N/A',
                    deliveryType: state.deliveryType,
                    items: state.cart,
                    total,
                    userId: state.user.uid.substring(0, 8)
                };
                
                // Renderizar contenido del modal
                document.getElementById('confirm-name').innerText = name;
                document.getElementById('confirm-phone').innerText = phone;
                document.getElementById('confirm-delivery').innerText = state.deliveryType === 'pickup' ? 'RECOGER EN TIENDA' : 'ENTREGA A DOMICILIO';
                document.getElementById('confirm-total').innerText = formatMoney(total);

                const addressDisplay = document.getElementById('confirm-address-display');
                if (state.deliveryType === 'delivery') {
                    document.getElementById('confirm-address').innerText = address;
                    addressDisplay.classList.remove('hidden');
                } else {
                    addressDisplay.classList.add('hidden');
                }

                const itemsList = document.getElementById('confirm-items-list');
                itemsList.innerHTML = state.cart.map(item => 
                    `<li class="text-data-gray border-b border-gray-900 last:border-b-0 py-1">
                        ${item.name} [${item.size}] - ${formatMoney(item.price)}
                    </li>`
                ).join('');

                // Abrir modal
                router.openModal('order-confirm-modal');
            },

            // Paso 2: Ejecuci√≥n final despu√©s de la confirmaci√≥n del modal
            sendOrderToWhatsapp: () => {
                const { name, phone, address, deliveryType, items, total, userId } = state.orderData;
                
                if (!name || items.length === 0) {
                     return showToast('ERROR: DATOS DE ORDEN INCOMPLETOS', 'error');
                }

                const orderId = Math.floor(Math.random() * 90000) + 10000;
                
                // --- INICIO DE CONSTRUCCI√ìN DEL MENSAJE DE WHATSAPP ---
                
                let msg = `ü§ñ *NUEVA ORDEN KURA // #${orderId}*%0A`;
                msg += `-----------------------------------%0A`;
                msg += `*DATOS DEL PILOTO:*%0A`;
                msg += `üë§ Nombre: ${name}%0A`;
                msg += `üÜî ID (Hash): ${userId}%0A`;
                msg += `üì± Contacto: ${phone}%0A`;
                msg += `üöö Tipo: *${deliveryType.toUpperCase()}*%0A`;
                
                if(deliveryType === 'delivery') {
                    // Reemplazar saltos de l√≠nea en la direcci√≥n con %0A
                    const formattedAddress = address.replace(/\n/g, ' ').trim(); 
                    msg += `üìç Direcci√≥n: ${formattedAddress}%0A`;
                }
                
                msg += `-----------------------------------%0A`;
                msg += `*LISTA DE EQUIPO:*%0A`;
                
                // Agregar cada item de forma detallada
                items.forEach((item, index) => {
                    // Usar * para negritas en WhatsApp y %0A para nuevo rengl√≥n
                    msg += `${index + 1}. *${item.name}* [${item.size}] - ${formatMoney(item.price)}%0A`;
                });
                
                msg += `-----------------------------------%0A`;
                msg += `üí∞ *COSTO TOTAL: ${formatMoney(total)}*%0A`;
                msg += `-----------------------------------%0A`;
                msg += `_Esperando confirmaci√≥n de env√≠o/recolecci√≥n. ID de Transacci√≥n: ${orderId}_`;
                
                // --- FIN DE CONSTRUCCI√ìN DEL MENSAJE DE WHATSAPP ---

                // Guardar en DB (asincr√≥nico)
                try {
                    push(ref(db, 'orders'), {
                        id: orderId,
                        date: new Date().toISOString(),
                        clientId: state.user.uid,
                        client: { name, phone, address: address === 'N/A' ? null : address },
                        items: items.map(i => ({ name: i.name, size: i.size, price: i.price })), // Guardar solo datos relevantes
                        total: total,
                        type: deliveryType
                    });
                } catch(e) { console.error("Error al guardar la orden:", e); }

                // Cerrar modal, limpiar carrito y abrir WhatsApp
                router.closeModal('order-confirm-modal');
                cartManager.clear();
                window.open(`https://wa.me/50584016969?text=${msg}`, '_blank'); // Reemplazar con el n√∫mero de KURA
            },

            renderHome: () => {
                const container = document.getElementById('app-container');
                container.innerHTML = `
                    <div class="relative h-[80vh] flex items-center justify-center hero-terminal border-b-4 border-neon-red/50 shadow-inner shadow-neon-red/10">
                        <!-- Animaci√≥n Glitch / Efecto de Scanline -->
                        
                        <div class="relative z-10 text-center px-4">
                            <p class="text-[10px] text-data-gray font-mono tracking-widest mb-2">CARGANDO // KURA.STUDIO_V4</p>
                            <h1 id="hero-title" class="text-7xl md:text-9xl font-cyber text-white mb-0 leading-none tracking-tighter select-none">KURA<span class="text-neon-red">.</span></h1>
                            <div class="h-1 w-24 bg-neon-red mx-auto my-6 animate-flicker-slow"></div>
                            <p class="text-neon-red font-mono tracking-[0.3em] text-xs md:text-sm uppercase">STREETWEAR NICARAGUA // Ëîµ„Çπ„Çø„Ç∏„Ç™</p>
                            
                            <button onclick="document.getElementById('shop-section').scrollIntoView({behavior:'smooth'})" class="mt-12 aggressive-btn px-8 py-3 text-sm tracking-widest font-cyber">
                                ACCEDER AL INVENTARIO
                            </button>
                        </div>
                    </div>

                    <div id="shop-section" class="py-16">
                        <div class="flex items-end justify-between mb-10 pb-4 border-b-4 border-neon-red">
                            <div>
                                <h2 class="text-4xl font-cyber text-white">LISTA DE EQUIPO // INVENTARIO</h2>
                                <p class="text-[10px] text-data-gray font-mono mt-2 uppercase">ESTADO_SYNC: OK</p>
                            </div>
                        </div>
                        <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                            <!-- Productos aqu√≠ -->
                        </div>
                    </div>
                `;
                logic.renderProductsGrid();
            }
        };

        // --- GESTOR DEL CARRITO ---
        window.cartManager = {
            toggle: () => {
                const sb = document.getElementById('cart-sidebar');
                const ov = document.getElementById('cart-overlay');
                const isOpen = !sb.classList.contains('translate-x-full');

                if (isOpen) {
                    sb.classList.add('translate-x-full');
                    ov.classList.add('opacity-0');
                    setTimeout(() => ov.classList.add('hidden'), 300);
                } else {
                    sb.classList.remove('translate-x-full');
                    ov.classList.remove('hidden');
                    requestAnimationFrame(() => ov.classList.remove('opacity-0'));
                    logic.setDelivery(state.deliveryType); // Resetear formulario delivery visualmente
                }
            },
            add: (product, size) => {
                state.cart.push({ 
                    ...product, 
                    size, 
                    cartId: Date.now(), // ID √∫nico para la eliminaci√≥n del item del carrito
                    price: Number(product.price) // Asegurar que el precio es un n√∫mero
                });
                cartManager.save();
                showToast(`+ ${product.name} [${size}]`);
            },
            remove: (cartId) => {
                state.cart = state.cart.filter(x => x.cartId !== cartId);
                cartManager.save();
            },
            save: () => {
                localStorage.setItem('cart', JSON.stringify(state.cart));
                cartManager.render();
            },
            clear: () => {
                state.cart = [];
                localStorage.removeItem('cart');
                cartManager.render();
                cartManager.toggle();
            },
            render: () => {
                document.getElementById('cart-counter').innerText = state.cart.length;
                const container = document.getElementById('cart-items-container');
                const checkoutSec = document.getElementById('checkout-section');
                container.innerHTML = '';
                
                let total = 0;

                if (state.cart.length === 0) {
                    container.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-gray-700 font-mono text-xs text-center p-10">
                            <i class="fas fa-cube text-4xl mb-4 opacity-50 text-neon-red"></i>
                            <p>INVENTARIO VAC√çO.<br>ASIGNA EQUIPO PARA CONTINUAR.</p>
                        </div>
                    `;
                    checkoutSec.classList.add('hidden');
                } else {
                    checkoutSec.classList.remove('hidden');
                    state.cart.forEach(item => {
                        total += (item.price || 0);
                        const img = item.image || item.imageUrl || 'https://placehold.co/100';
                        
                        container.innerHTML += `
                            <div class="flex gap-3 bg-[#111] p-3 border-2 border-gray-800 relative group transition hover:border-neon-red">
                                <img src="${img}" onerror="this.src='https://placehold.co/100'" class="w-16 h-20 object-cover grayscale opacity-80 group-hover:opacity-100 group-hover:grayscale-0 transition">
                                <div class="flex-1 flex flex-col justify-center">
                                    <h4 class="font-bold text-white text-xs leading-tight line-clamp-1 mb-1 font-cyber">${item.name}</h4>
                                    <div class="flex gap-2 text-[10px] font-mono text-data-gray">
                                        <span class="border border-gray-700 px-1 rounded text-white bg-gray-700">${item.size}</span>
                                    </div>
                                    <p class="text-neon-red font-bold text-sm mt-2 font-mono">${formatMoney(item.price)}</p>
                                </div>
                                <button onclick="cartManager.remove(${item.cartId})" class="text-gray-600 hover:text-neon-red transition px-2"><i class="fas fa-times"></i></button>
                            </div>
                        `;
                    });
                }
                document.getElementById('cart-total').innerText = formatMoney(total);
            }
        };

        // --- ENRUTADOR ---
        window.router = {
            loadRoute: () => {
                const hash = window.location.hash.substring(1); // Eliminar '#'
                const container = document.getElementById('app-container');
                window.scrollTo({ top: 0, behavior: 'smooth' });

                if (!hash || hash === 'home') {
                    logic.renderHome();
                } else if (hash.startsWith('product/')) {
                    const productId = hash.split('/')[1];
                    logic.renderProductDetail(productId);
                } else {
                     // 404
                    container.innerHTML = `<div class="text-center py-40 text-data-gray font-mono">ERROR 404: RUTA NO ENCONTRADA. <a href="#home" class="text-neon-red">VOLVER</a></div>`;
                }
            },
            navigate: (route) => {
                window.location.hash = route;
            },
            openModal: (id) => {
                document.getElementById(id).classList.remove('hidden');
                document.getElementById(id).classList.add('flex');
            },
            closeModal: (id) => {
                document.getElementById(id).classList.add('hidden');
                document.getElementById(id).classList.remove('flex');
            }
        };

        // Llamadas Iniciales
        logic.init();
        cartManager.render();
    </script>
</body>
</html>
